"use strict";var t=require("../../../../common/vendor.js");const e={trustTags:l("a,abbr,ad,audio,b,blockquote,br,code,col,colgroup,dd,del,dl,dt,div,em,fieldset,h1,h2,h3,h4,h5,h6,hr,i,img,ins,label,legend,li,ol,p,q,ruby,rt,source,span,strong,sub,sup,table,tbody,td,tfoot,th,thead,tr,title,ul,video"),blockTags:l("address,article,aside,body,caption,center,cite,footer,header,html,nav,pre,section"),inlineTags:l("abbr,b,big,code,del,em,i,ins,label,q,small,span,strong,sub,sup"),ignoreTags:l("area,base,canvas,embed,frame,head,iframe,input,link,map,meta,param,rp,script,source,style,textarea,title,track,wbr"),voidTags:l("area,base,br,col,circle,ellipse,embed,frame,hr,img,input,line,link,meta,param,path,polygon,rect,source,track,use,wbr"),entities:{lt:"<",gt:">",quot:'"',apos:"'",ensp:" ",emsp:" ",nbsp:" ",semi:";",ndash:"–",mdash:"—",middot:"·",lsquo:"‘",rsquo:"’",ldquo:"“",rdquo:"”",bull:"•",hellip:"…",larr:"←",uarr:"↑",rarr:"→",darr:"↓"},tagStyle:{address:"font-style:italic",big:"display:inline;font-size:1.2em",caption:"display:table-caption;text-align:center",center:"text-align:center",cite:"font-style:italic",dd:"margin-left:40px",mark:"background-color:yellow",pre:"font-family:monospace;white-space:pre",s:"text-decoration:line-through",small:"display:inline;font-size:0.8em",strike:"text-decoration:line-through",u:"text-decoration:underline"},svgDict:{animatetransform:"animateTransform",lineargradient:"linearGradient",viewbox:"viewBox",attributename:"attributeName",repeatcount:"repeatCount",repeatdur:"repeatDur"}},i={},{windowWidth:s,system:n}=t.index.getSystemInfoSync(),a=l(" ,\r,\n,\t,\f");let r=0;function l(t){const e=Object.create(null),i=t.split(",");for(let s=i.length;s--;)e[i[s]]=!0;return e}function o(t,i){let s=t.indexOf("&");for(;-1!==s;){const n=t.indexOf(";",s+3);let a;if(-1===n)break;"#"===t[s+1]?(a=parseInt(("x"===t[s+2]?"0":"")+t.substring(s+2,n)),isNaN(a)||(t=t.substr(0,s)+String.fromCharCode(a)+t.substr(n+1))):(a=t.substring(s+1,n),(e.entities[a]||"amp"===a&&i)&&(t=t.substr(0,s)+(e.entities[a]||"&")+t.substr(n+1))),s=t.indexOf("&",s+1)}return t}function h(t){this.options=t||{},this.tagStyle=Object.assign({},e.tagStyle,this.options.tagStyle),this.imgList=t.imgList||[],this.plugins=t.plugins||[],this.attrs=Object.create(null),this.stack=[],this.nodes=[],this.pre=(this.options.containerStyle||"").includes("white-space")&&this.options.containerStyle.includes("pre")?2:0}function c(t){this.handler=t}h.prototype.parse=function(t){for(let i=this.plugins.length;i--;)this.plugins[i].onUpdate&&(t=this.plugins[i].onUpdate(t,e)||t);for(new c(this).parse(t);this.stack.length;)this.popNode();return this.nodes},h.prototype.expose=function(){for(let t=this.stack.length;t--;){const e=this.stack[t];if(e.c||"a"===e.name||"video"===e.name||"audio"===e.name)return;e.c=1}},h.prototype.hook=function(t){for(let e=this.plugins.length;e--;)if(this.plugins[e].onParse&&!1===this.plugins[e].onParse(t,this))return!1;return!0},h.prototype.getUrl=function(t){const e=this.options.domain;return"/"===t[0]?"/"===t[1]?t=(e?e.split("://")[0]:"http")+":"+t:e&&(t=e+t):t.includes("data:")||t.includes("://")||e&&(t=e+"/"+t),t},h.prototype.parseStyle=function(t){const e=t.attrs,i=(this.tagStyle[t.name]||"").split(";").concat((e.style||"").split(";")),n={};let r="";e.id&&!this.xml&&(this.options.useAnchor?this.expose():"img"!==t.name&&"a"!==t.name&&"video"!==t.name&&"audio"!==t.name&&(e.id=void 0)),e.width&&(n.width=parseFloat(e.width)+(e.width.includes("%")?"%":"px"),e.width=void 0),e.height&&(n.height=parseFloat(e.height)+(e.height.includes("%")?"%":"px"),e.height=void 0);for(let l=0,o=i.length;l<o;l++){const t=i[l].split(":");if(t.length<2)continue;const e=t.shift().trim().toLowerCase();let o=t.join(":").trim();if("-"===o[0]&&o.lastIndexOf("-")>0||o.includes("safe"))r+=`;${e}:${o}`;else if(!n[e]||o.includes("import")||!n[e].includes("import")){if(o.includes("url")){let t=o.indexOf("(")+1;if(t){for(;'"'===o[t]||"'"===o[t]||a[o[t]];)t++;o=o.substr(0,t)+this.getUrl(o.substr(t))}}else o.includes("rpx")&&(o=o.replace(/[0-9.]+\s*rpx/g,(t=>parseFloat(t)*s/750+"px")));n[e]=o}}return t.attrs.style=r,n},h.prototype.onTagName=function(t){this.tagName=this.xml?t:t.toLowerCase(),"svg"===this.tagName&&(this.xml=(this.xml||0)+1)},h.prototype.onAttrName=function(t){"data-"===(t=this.xml?t:t.toLowerCase()).substr(0,5)?"data-src"!==t||this.attrs.src?"img"===this.tagName||"a"===this.tagName?this.attrName=t:this.attrName=void 0:this.attrName="src":(this.attrName=t,this.attrs[t]="T")},h.prototype.onAttrVal=function(t){const e=this.attrName||"";"style"===e||"href"===e?this.attrs[e]=o(t,!0):e.includes("src")?this.attrs[e]=this.getUrl(o(t,!0)):e&&(this.attrs[e]=t)},h.prototype.onOpenTag=function(t){const n=Object.create(null);n.name=this.tagName,n.attrs=this.attrs,this.options.nodes.length&&(n.type="node"),this.attrs=Object.create(null);const a=n.attrs,l=this.stack[this.stack.length-1],o=l?l.children:this.nodes,h=this.xml?t:e.voidTags[n.name];if(i[n.name]&&(a.class=i[n.name]+(a.class?" "+a.class:"")),"embed"===n.name){const t=a.src||"";t.includes(".mp4")||t.includes(".3gp")||t.includes(".m3u8")||(a.type||"").includes("video")?n.name="video":(t.includes(".mp3")||t.includes(".wav")||t.includes(".aac")||t.includes(".m4a")||(a.type||"").includes("audio"))&&(n.name="audio"),a.autostart&&(a.autoplay="T"),a.controls="T"}if("video"!==n.name&&"audio"!==n.name||("video"!==n.name||a.id||(a.id="v"+r++),a.controls||a.autoplay||(a.controls="T"),n.src=[],a.src&&(n.src.push(a.src),a.src=void 0),this.expose()),h){if(!this.hook(n)||e.ignoreTags[n.name])return void("base"!==n.name||this.options.domain?"source"===n.name&&l&&("video"===l.name||"audio"===l.name)&&a.src&&l.src.push(a.src):this.options.domain=a.href);const t=this.parseStyle(n);if("img"===n.name){if(a.src&&(a.src.includes("webp")&&(n.webp="T"),a.src.includes("data:")&&!a["original-src"]&&(a.ignore="T"),!a.ignore||n.webp||a.src.includes("cloud://"))){for(let i=this.stack.length;i--;){const e=this.stack[i];if("a"===e.name){n.a=e.attrs;break}const s=e.attrs.style||"";if(!s.includes("flex:")||s.includes("flex:0")||s.includes("flex: 0")||t.width&&t.width.includes("%"))if(s.includes("flex")&&"100%"===t.width)for(let n=i+1;n<this.stack.length;n++){const e=this.stack[n].attrs.style||"";if(!e.includes(";width")&&!e.includes(" width")&&0!==e.indexOf("width")){t.width="";break}}else s.includes("inline-block")&&(t.width&&"%"===t.width[t.width.length-1]?(e.attrs.style+=";max-width:"+t.width,t.width=""):e.attrs.style+=";max-width:100%");else{t.width="100% !important",t.height="";for(let t=i+1;t<this.stack.length;t++)this.stack[t].attrs.style=(this.stack[t].attrs.style||"").replace("inline-","")}e.c=1}a.i=this.imgList.length.toString();let e=a["original-src"]||a.src;if(this.imgList.includes(e)){let t=e.indexOf("://");if(-1!==t){t+=3;let i=e.substr(0,t);for(;t<e.length&&"/"!==e[t];t++)i+=Math.random()>.5?e[t].toUpperCase():e[t];i+=e.substr(t),e=i}}this.imgList.push(e)}"inline"===t.display&&(t.display=""),a.ignore&&(t["max-width"]=t["max-width"]||"100%",a.style+=";-webkit-touch-callout:none"),parseInt(t.width)>s&&(t.height=void 0),isNaN(parseInt(t.width))||(n.w="T"),!isNaN(parseInt(t.height))&&(!t.height.includes("%")||l&&(l.attrs.style||"").includes("height"))&&(n.h="T")}else if("svg"===n.name)return o.push(n),this.stack.push(n),void this.popNode();for(const e in t)t[e]&&(a.style+=`;${e}:${t[e].replace(" !important","")}`);a.style=a.style.substr(1)||void 0,a.style||delete a.style}else("pre"===n.name||(a.style||"").includes("white-space")&&a.style.includes("pre"))&&2!==this.pre&&(this.pre=n.pre=1),n.children=[],this.stack.push(n);o.push(n)},h.prototype.onCloseTag=function(t){let e;for(t=this.xml?t:t.toLowerCase(),e=this.stack.length;e--&&this.stack[e].name!==t;);if(-1!==e)for(;this.stack.length>e;)this.popNode();else if("p"===t||"br"===t){(this.stack.length?this.stack[this.stack.length-1].children:this.nodes).push({name:t,attrs:{class:i[t]||"",style:this.tagStyle[t]||""}})}},h.prototype.popNode=function(){const i=this.stack.pop();let n=i.attrs;const a=i.children,r=this.stack[this.stack.length-1],l=r?r.children:this.nodes;if(!this.hook(i)||e.ignoreTags[i.name])return"title"===i.name&&a.length&&"text"===a[0].type&&this.options.setTitle&&t.index.setNavigationBarTitle({title:a[0].text}),void l.pop();if(i.pre&&2!==this.pre){this.pre=i.pre=void 0;for(let t=this.stack.length;t--;)this.stack[t].pre&&(this.pre=1)}const o={};if("svg"===i.name){if(this.xml>1)return void this.xml--;let t="";const s=n.style;return n.style="",n.xmlns="http://www.w3.org/2000/svg",function i(s){if("text"===s.type)return void(t+=s.text);const n=e.svgDict[s.name]||s.name;t+="<"+n;for(const a in s.attrs){const i=s.attrs[a];i&&(t+=` ${e.svgDict[a]||a}="${i}"`)}if(s.children){t+=">";for(let t=0;t<s.children.length;t++)i(s.children[t]);t+="</"+n+">"}else t+="/>"}(i),i.name="img",i.attrs={src:"data:image/svg+xml;utf8,"+t.replace(/#/g,"%23"),style:s,ignore:"T"},i.children=void 0,void(this.xml=!1)}if(n.align&&("table"===i.name?"center"===n.align?o["margin-inline-start"]=o["margin-inline-end"]="auto":o.float=n.align:o["text-align"]=n.align,n.align=void 0),n.dir&&(o.direction=n.dir,n.dir=void 0),"font"===i.name&&(n.color&&(o.color=n.color,n.color=void 0),n.face&&(o["font-family"]=n.face,n.face=void 0),n.size)){let t=parseInt(n.size);isNaN(t)||(t<1?t=1:t>7&&(t=7),o["font-size"]=["x-small","small","medium","large","x-large","xx-large","xxx-large"][t-1]),n.size=void 0}if((n.class||"").includes("align-center")&&(o["text-align"]="center"),Object.assign(o,this.parseStyle(i)),"table"!==i.name&&parseInt(o.width)>s&&(o["max-width"]="100%",o["box-sizing"]="border-box"),e.blockTags[i.name]?i.name="div":e.trustTags[i.name]||this.xml||(i.name="span"),"a"===i.name||"ad"===i.name)this.expose();else if("video"===i.name)(o.height||"").includes("auto")&&(o.height=void 0);else if("ul"!==i.name&&"ol"!==i.name||!i.c){if("table"===i.name){let t=parseFloat(n.cellpadding),e=parseFloat(n.cellspacing);const s=parseFloat(n.border);if(i.c&&(isNaN(t)&&(t=2),isNaN(e)&&(e=2)),s&&(n.style+=";border:"+s+"px solid gray"),i.flag&&i.c){o.display="grid",e?(o["grid-gap"]=e+"px",o.padding=e+"px"):s&&(n.style+=";border-left:0;border-top:0");const r=[],l=[],h=[],c={};!function t(e){for(let i=0;i<e.length;i++)"tr"===e[i].name?l.push(e[i]):t(e[i].children||[])}(a);for(let i=1;i<=l.length;i++){let n=1;for(let a=0;a<l[i-1].children.length;a++){const o=l[i-1].children[a];if("td"===o.name||"th"===o.name){for(;c[i+"."+n];)n++;let a=o.attrs.style||"";const l=a.indexOf("width")?a.indexOf(";width"):0;if(-1!==l){let t=a.indexOf(";",l+6);-1===t&&(t=a.length),o.attrs.colspan||(r[n]=a.substring(l?l+7:6,t)),a=a.substr(0,l)+a.substr(t)}if(a+=(s?`;border:${s}px solid gray`+(e?"":";border-right:0;border-bottom:0"):"")+(t?`;padding:${t}px`:""),o.attrs.colspan&&(a+=`;grid-column-start:${n};grid-column-end:${n+parseInt(o.attrs.colspan)}`,o.attrs.rowspan||(a+=`;grid-row-start:${i};grid-row-end:${i+1}`),n+=parseInt(o.attrs.colspan)-1),o.attrs.rowspan){a+=`;grid-row-start:${i};grid-row-end:${i+parseInt(o.attrs.rowspan)}`,o.attrs.colspan||(a+=`;grid-column-start:${n};grid-column-end:${n+1}`);for(let t=1;t<o.attrs.rowspan;t++)for(let e=0;e<(o.attrs.colspan||1);e++)c[i+t+"."+(n-e)]=1}a&&(o.attrs.style=a),h.push(o),n++}}if(1===i){let t="";for(let e=1;e<n;e++)t+=(r[e]?r[e]:"auto")+" ";o["grid-template-columns"]=t}}i.children=h}else i.c&&(o.display="table"),isNaN(e)||(o["border-spacing"]=e+"px"),(s||t)&&function e(i){for(let n=0;n<i.length;n++){const a=i[n];"th"===a.name||"td"===a.name?(s&&(a.attrs.style=`border:${s}px solid gray;${a.attrs.style||""}`),t&&(a.attrs.style=`padding:${t}px;${a.attrs.style||""}`)):a.children&&e(a.children)}}(a);if(this.options.scrollTable&&!(n.style||"").includes("inline")){const t=Object.assign({},i);i.name="div",i.attrs={style:"overflow:auto"},i.children=[t],n=t.attrs}}else if("td"!==i.name&&"th"!==i.name||!n.colspan&&!n.rowspan)if("ruby"===i.name){i.name="span";for(let t=0;t<a.length-1;t++)"text"===a[t].type&&"rt"===a[t+1].name&&(a[t]={name:"div",attrs:{style:"display:inline-block;text-align:center"},children:[{name:"div",attrs:{style:"font-size:50%;"+(a[t+1].attrs.style||"")},children:a[t+1].children},a[t]]},a.splice(t+1,1))}else i.c&&function t(i){i.c=2;for(let s=i.children.length;s--;){const n=i.children[s];n.name&&(e.inlineTags[n.name]||(n.attrs.style||"").includes("inline"))&&!n.c&&t(n),n.c&&"table"!==n.name||(i.c=1)}}(i);else for(let t=this.stack.length;t--;)if("table"===this.stack[t].name){this.stack[t].flag=1;break}}else{const t={a:"lower-alpha",A:"upper-alpha",i:"lower-roman",I:"upper-roman"};t[n.type]&&(n.style+=";list-style-type:"+t[n.type],n.type=void 0);for(let e=a.length;e--;)"li"===a[e].name&&(a[e].c=1)}if((o.display||"").includes("flex")&&!i.c)for(let t=a.length;t--;){const e=a[t];e.f&&(e.attrs.style=(e.attrs.style||"")+e.f,e.f=void 0)}const h=r&&((r.attrs.style||"").includes("flex")||(r.attrs.style||"").includes("grid"))&&!(i.c&&wx.getNFCAdapter);if(h&&(i.f=";max-width:100%"),a.length>=50&&i.c&&!(o.display||"").includes("flex")){let t=a.length-1;for(let e=t;e>=-1;e--)(-1===e||a[e].c||!a[e].name||"div"!==a[e].name&&"p"!==a[e].name&&"h"!==a[e].name[0]||(a[e].attrs.style||"").includes("inline"))&&(t-e>=5&&a.splice(e+1,t-e,{name:"div",attrs:{},children:i.children.slice(e+1,t+1)}),t=e-1)}for(const t in o)if(o[t]){const e=`;${t}:${o[t].replace(" !important","")}`;h&&(t.includes("flex")&&"flex-direction"!==t||"align-self"===t||t.includes("grid")||"-"===o[t][0]||t.includes("width")&&e.includes("%"))?(i.f+=e,"width"===t&&(n.style+=";width:100%")):n.style+=e}n.style=n.style.substr(1)||void 0;for(const t in n)n[t]||delete n[t]},h.prototype.onText=function(e){if(!this.pre){let t,i="";for(let s=0,n=e.length;s<n;s++)a[e[s]]?(" "!==i[i.length-1]&&(i+=" "),"\n"!==e[s]||t||(t=!0)):i+=e[s];if(" "===i&&t)return;e=i}const i=Object.create(null);if(i.type="text",i.text=o(e),this.hook(i)){"force"===this.options.selectable&&n.includes("iOS")&&!t.index.canIUse("rich-text.user-select")&&this.expose();(this.stack.length?this.stack[this.stack.length-1].children:this.nodes).push(i)}},c.prototype.parse=function(t){this.content=t||"",this.i=0,this.start=0,this.state=this.text;for(let e=this.content.length;-1!==this.i&&this.i<e;)this.state()},c.prototype.checkClose=function(t){const e="/"===this.content[this.i];return!!(">"===this.content[this.i]||e&&">"===this.content[this.i+1])&&(t&&this.handler[t](this.content.substring(this.start,this.i)),this.i+=e?2:1,this.start=this.i,this.handler.onOpenTag(e),"script"===this.handler.tagName?(this.i=this.content.indexOf("</",this.i),-1!==this.i&&(this.i+=2,this.start=this.i),this.state=this.endTag):this.state=this.text,!0)},c.prototype.text=function(){if(this.i=this.content.indexOf("<",this.i),-1===this.i)return void(this.start<this.content.length&&this.handler.onText(this.content.substring(this.start,this.content.length)));const t=this.content[this.i+1];if(t>="a"&&t<="z"||t>="A"&&t<="Z")this.start!==this.i&&this.handler.onText(this.content.substring(this.start,this.i)),this.start=++this.i,this.state=this.tagName;else if("/"===t||"!"===t||"?"===t){this.start!==this.i&&this.handler.onText(this.content.substring(this.start,this.i));const e=this.content[this.i+2];if("/"===t&&(e>="a"&&e<="z"||e>="A"&&e<="Z"))return this.i+=2,this.start=this.i,void(this.state=this.endTag);let i="--\x3e";"!"===t&&"-"===this.content[this.i+2]&&"-"===this.content[this.i+3]||(i=">"),this.i=this.content.indexOf(i,this.i),-1!==this.i&&(this.i+=i.length,this.start=this.i)}else this.i++},c.prototype.tagName=function(){if(a[this.content[this.i]]){for(this.handler.onTagName(this.content.substring(this.start,this.i));a[this.content[++this.i]];);this.i<this.content.length&&!this.checkClose()&&(this.start=this.i,this.state=this.attrName)}else this.checkClose("onTagName")||this.i++},c.prototype.attrName=function(){let t=this.content[this.i];if(a[t]||"="===t){this.handler.onAttrName(this.content.substring(this.start,this.i));let e="="===t;const i=this.content.length;for(;++this.i<i;)if(t=this.content[this.i],!a[t]){if(this.checkClose())return;if(e)return this.start=this.i,void(this.state=this.attrVal);if("="!==this.content[this.i])return this.start=this.i,void(this.state=this.attrName);e=!0}}else this.checkClose("onAttrName")||this.i++},c.prototype.attrVal=function(){const t=this.content[this.i],e=this.content.length;if('"'===t||"'"===t){if(this.start=++this.i,this.i=this.content.indexOf(t,this.i),-1===this.i)return;this.handler.onAttrVal(this.content.substring(this.start,this.i))}else for(;this.i<e;this.i++){if(a[this.content[this.i]]){this.handler.onAttrVal(this.content.substring(this.start,this.i));break}if(this.checkClose("onAttrVal"))return}for(;a[this.content[++this.i]];);this.i<e&&!this.checkClose()&&(this.start=this.i,this.state=this.attrName)},c.prototype.endTag=function(){const t=this.content[this.i];if(a[t]||">"===t||"/"===t){if(this.handler.onCloseTag(this.content.substring(this.start,this.i)),">"!==t&&(this.i=this.content.indexOf(">",this.i),-1===this.i))return;this.start=++this.i,this.state=this.text}else this.i++},exports.Parser=h;
